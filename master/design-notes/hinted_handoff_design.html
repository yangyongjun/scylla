


<!doctype html>
<html class="no-js" lang="en">
  
<head><!-- begin head.html -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
    Hinted Handoff Design | Scylla Docs
    </title>
    <meta name="description" content="Scylla is an Apache Cassandra-compatible NoSQL data store that can handle 1 million transactions per second on a single server."/>

    <link rel="icon" href="../_static/img/favicon.ico" type="image/x-icon"/>
    <link rel="canonical" href="https://docs.scylladb.com/">

    <link rel="author" href="mailto:info@scylladb.com">
    <link rel="stylesheet" href="../_static/" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_tabs/semantic-ui-2.4.1/segment.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_tabs/semantic-ui-2.4.1/menu.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_tabs/semantic-ui-2.4.1/tab.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_tabs/tabs.css" />
    
    <link href='https://fonts.googleapis.com/css?family=Roboto:400,100,300,500,700' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/foundation/5.5.2/css/foundation.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/css/doc/main.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>

    <script src="../_static/js/vendor/modernizr.js"></script>
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
      new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-T8P2JP');</script>
    <!-- End Google Tag Manager -->

    <!-- Marketo -->
    <script type="text/javascript"> (function() { var didInit = false; function initMunchkin() { if(didInit === false) { didInit = true; Munchkin.init('791-QBF-350'); } } var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = '//munchkin.marketo.net/munchkin.js'; s.onreadystatechange = function() { if (this.readyState == 'complete' || this.readyState == 'loaded') { initMunchkin(); } }; s.onload = initMunchkin; document.getElementsByTagName('head')[0].appendChild(s); })(); </script>
    <!-- End Marketo -->

<!-- end head.html -->
</head>

<body>



<header id="header" class="animated">
    <div class="topbar_continer contain-to-grid clearfix">
        <nav class="top-bar" id="top-bar" data-topbar role="navigation">
            <ul class="title-area">
                <li class="name">
                    <div class="logo">
                        <a href="https://docs.scylladb.com/"><img src="../_static/img/logo-scylla-docs.svg" alt="" width="151"></a>
                    </div>
                </li>
                <li class="toggle-topbar"><a href="#"><span class="icon-manu"></span></a></li>
            </ul>
            <section class="top-bar-section clearfix">
                <ul class="right">
                    
                    <li>
                        <a href="https://scylla.docs.scylladb.com">Scylla Developer Notes</a>
                    </li>
                    
                    <li>
                        <a href="https://university.scylladb.com/">Scylla University</a>
                    </li>
                    
                    <li>
                        <a href="https://www.scylladb.com/">ScyllaDB Home</a>
                    </li>
                    
                    <li class="search_continer show-for-medium-up">	
                        <ci-search></ci-search>	
                    </li>	
                </ul>
            </section>
        </nav>
    </div>
</header>
<section id="content">
    <div class="row">
	
	<div class="large-6 large-push-3 columns">

        

        <section id="hinted-handoff-design">
<h1>Hinted Handoff Design<a class="headerlink" href="#hinted-handoff-design" title="Permalink to this headline">¶</a></h1>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>Hinted Handoff is a feature that allows replaying failed writes. The mutation and the destination replica are saved in a log and replayed later according to the feature configuration.</p>
</section>
<section id="hinted-handoff-configuration-parameters">
<h2>Hinted Handoff Configuration Parameters<a class="headerlink" href="#hinted-handoff-configuration-parameters" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><em>hinted_handoff_enabled</em>: Enables or disables the Hinted Handoff feature completely or enumerate DCs for which hints are allowed.</p></li>
<li><p><em>max_hint_window_in_ms</em>: Don’t generate hints if the destination Node has been down for more than this value. The hints generation should resume once the Node is seen up.</p></li>
<li><p><em>hints_directory</em>: Directory where scylla will store hints. By default <code class="docutils literal notranslate"><span class="pre">$SCYLLA_HOME/hints</span></code></p></li>
<li><p><em>hints_compression</em>: Compression to apply to hints files. By default, hints files are stored uncompressed.</p></li>
</ul>
</section>
<section id="future-configuration">
<h2>Future configuration<a class="headerlink" href="#future-configuration" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>We should define the fairness configuration between the regular WRITES and hints WRITES.
Since we don’t have either CPU scheduler or (and) Network scheduler at the moment we can’t give any guarantee regarding the runtime and/or networking bandwidth fairness.
Once we have tools to define it we should give the hints sender some low runtime priority and some small share of the bandwidth.</p></li>
</ul>
</section>
<section id="hints-generation">
<h2>Hints generation<a class="headerlink" href="#hints-generation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Once the WRITE mutation fails with a timeout we create a <em>hints_queue</em> for the target node.</p>
<ul>
<li><p>The queue is specified by a destination node IP.</p></li>
</ul>
</li>
<li><p>Each hint is specified by:</p>
<ul>
<li><p>Mutation.</p></li>
<li><p>Destination node.</p></li>
</ul>
</li>
</ul>
<p>Hints are appended to the <em>hints_queue</em> until (all this should be done using the existing or slightly modified <em>commitlog</em> API):</p>
<ul class="simple">
<li><p>The destination node is DOWN for more than <em>max_hint_window_in_ms</em> time.</p></li>
<li><p>The total size of hint files is more than 10% of the total disk partition size where <em>hints_directory</em> is located.</p></li>
<li><p>We are going to ensure storing a new hint to the specific destination node if there are no pending hints to it.</p></li>
</ul>
<p>As long as hints are appended to the queue the files are closed and flushed to the disk once they reach the maximum allowed size (32MB) or when the queue is forcefully flushed (see “Hints sending” below).</p>
<p>We are going to reuse the commitlog infrastructure for writing hints to disk - it provides both the internal buffering and the memory consumption control.</p>
<p>Hints to the specific destination are stored under the <em>hints_directory</em>/&lt;shard ID&gt;/&lt;node IP&gt; directory.</p>
<section id="when-new-hints-may-be-dropped">
<h3>When new hints may be dropped?<a class="headerlink" href="#when-new-hints-may-be-dropped" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>A new hint is going to be dropped when there are more than 10MB “in progress” (yet to be stored) hints per-shard and when there are  “in progress” hints to the destination the current hint is aimed to.</p>
<ul>
<li><p>If there are no “in progress” hints to the current destination the new hint won’t be dropped due to the per-shard memory limitation.</p></li>
</ul>
</li>
<li><p>A hint is going to be dropped if the disk space quota (to the whole node it’s 10% of the total disk space of the disk partition where <em>hints_directory</em> is located) has been depleted and when there are pending (already stored) hints to the current destination.</p>
<ul>
<li><p>Disk quota is divided equally between all present shards.</p></li>
<li><p>If there are no pending hints to the current destination a new hint won’t be dropped due to a disk space limitation.</p></li>
</ul>
</li>
<li><p>If a new hint is dropped the corresponding metrics counter is increased.</p></li>
</ul>
</section>
<section id="redistribution-of-hints-when-node-boots">
<h3>Redistribution of hints when node boots.<a class="headerlink" href="#redistribution-of-hints-when-node-boots" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>When node boots all present hints files are redistributed equally between all present shards.</p></li>
</ul>
</section>
</section>
<section id="hints-sending">
<h2>Hints sending<a class="headerlink" href="#hints-sending" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Hints are sent from each shard by each <em>hints_queue</em> independently.</p></li>
<li><p>Each shard sends the hints that it owns (according to the hint file location).</p></li>
<li><p>Hints sending is triggered by the following events:</p>
<ul>
<li><p>Timer: every X seconds (every 10s).</p>
<ul>
<li><p>For each queue:</p>
<ul>
<li><p>Forcefully close the queues.</p></li>
</ul>
</li>
<li><p>If the destination node is ALIVE or decommissioned and there are pending hints to it start sending hints to it:</p>
<ul>
<li><p>If hint’s timestamp is older than mutation.gc_grace_seconds() from now() drop this hint. The hint’s timestamp is evaluated as <em>hints_file</em> last modification time minus the hints timer period (10s).</p></li>
<li><p>Hints are sent using a MUTATE verb:</p>
<ul>
<li><p>Each mutation is sent in a separate message.</p>
<ul>
<li><p>If the node in the hint is a valid mutation replica - send the mutation to it.</p></li>
<li><p>Otherwise execute the original mutation with CL=ALL.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Once the complete hints file is processed it’s deleted and we move to the next file.</p></li>
<li><p>We are going to limit the parallelism during hints sending. The new hint is going to be sent out unless:</p>
<ul>
<li><p>The total size of in-flight (being sent) hints is greater or equal to 10% of the total shard memory.</p></li>
<li><p>The number of in-flight hints is greater or equal to 128 - this is needed to limit the collateral memory consumption in case of small hints (mutations).</p></li>
</ul>
</li>
<li><p>If there is a hint that is bigger than the memory limit above we are going to send it but won’t allow any additional in-flight hints while it’s being sent.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Local node is decommissioned (see “When the current node is decommissioned” below).</p></li>
</ul>
</li>
</ul>
</section>
<section id="when-the-current-node-is-decommissioned-in-the-absence-of-hints-streaming">
<h2>When the current node is decommissioned (in the absence of Hints Streaming)<a class="headerlink" href="#when-the-current-node-is-decommissioned-in-the-absence-of-hints-streaming" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Send all pending hints out:</p>
<ul>
<li><p>If the destination node is not ALIVE or the mutation times out - drop the hint and move on to the next one.</p></li>
</ul>
</li>
</ul>
</section>
<section id="hints-streaming-optional">
<h2>Hints streaming (optional)<a class="headerlink" href="#hints-streaming-optional" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Streaming is performed using a new HINT_STREAMING verb:</p>
<ul>
<li><p>When node is decommissioned it would stream its hints to other nodes of the cluster (only in a Local data center):</p>
<ul>
<li><p>Shard X would send its hints to the node[Yx], where Yx = X mod N, where N is number of nodes in the cluster without the node that is being decommissioned.</p></li>
</ul>
</li>
<li><p>Receiver distributes received hints equally among local shards: pushes them to the corresponding _hint_queue_s (see “Hints generation” above).</p></li>
</ul>
</li>
</ul>
</section>
</section>

        </div>

        <div id="sidebar" class="large-3 large-pull-6 columns"><div class="side-nav">
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Scylla Developer Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../alternator/alternator.html">Alternator: DynamoDB API in Scylla</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Design Notes</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="IDL.html">IDL definition</a></li>
<li class="toctree-l2"><a class="reference internal" href="cdc.html">CDC</a></li>
<li class="toctree-l2"><a class="reference internal" href="compaction_controller.html">The Compaction Controller</a></li>
<li class="toctree-l2"><a class="reference internal" href="cql-extensions.html">Scylla CQL extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="cql-extensions-internal.html">Scylla CQL extensions</a></li>
<li class="toctree-l2"><a class="reference internal" href="cql3-type-mapping.html">CQL3 Type Mapping</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Hinted Handoff Design</a></li>
<li class="toctree-l2"><a class="reference internal" href="isolation.html">Performance Isolation in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="lua-type-mapping.html">CQL to Lua type mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="metrics.html">Scylla Metrics</a></li>
<li class="toctree-l2"><a class="reference internal" href="migrating-from-users-to-roles.html">Migrating from users to roles</a></li>
<li class="toctree-l2"><a class="reference internal" href="paged-queries.html">Paged queries</a></li>
<li class="toctree-l2"><a class="reference internal" href="protocol-extensions.html">Protocol extensions to the Cassandra Native Protocol</a></li>
<li class="toctree-l2"><a class="reference internal" href="protocols.html">Ports and protocols in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="redis.html">Redis API in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="repair_based_node_ops.html">Repair based node operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="row_cache.html">Row Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="row_level_repair.html">Row level repair</a></li>
<li class="toctree-l2"><a class="reference internal" href="secondary_index.html">Secondary indexes in Scylla</a></li>
<li class="toctree-l2"><a class="reference internal" href="sstable-scylla-format.html">File format of the Scylla.db sstable component</a></li>
<li class="toctree-l2"><a class="reference internal" href="sstables-directory-structure.html">sstables directory structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="system_keyspace.html">System keyspace layout</a></li>
<li class="toctree-l2"><a class="reference internal" href="system_schema_keyspace.html">System schema keyspace layout</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../guides/index.html">Guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contribute/index.html">Contribute</a></li>
</ul>

</div>
        </div>

        <div class="large-3 columns">
            
                <div class="versions-dropdown single-version">
    <button class="button">
    
        master
    
	 <i class="fa fa-caret-down" aria-hidden="true"></i>
    </button>
    <ul class="content">
            <li><a href="hinted_handoff_design.html">master</a></li>
    </ul>
</div>
            
        </div>

    </div>
</section>

<!-- newsleter modal -->

<div id="newsletter_signup" class="reveal-modal tiny radius dark_modal" data-reveal aria-labelledby="modalTitle" aria-hidden="true" role="dialog">
    <a class="close-reveal-modal" aria-label="Close">×</a>
    <h2 id="modalTitle">Sign up for the Scylla newsletter</h2>
    <div id="mc_embed_signup">
        <form action="//cloudius-systems.us10.list-manage.com/subscribe/post?u=df8bb543c68230d5f7b4dcf78&amp;id=9a4589f144" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
            <div id="mc_embed_signup_scroll">

                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-EMAIL">Email</label></div>
                        <div class="small-9 columns"><input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL"></div>
                    </div>
                </div>
                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-FNAME">First Name </label></div>
                        <div class="small-9 columns"><input type="text" value="" name="FNAME" class="" id="mce-FNAME"></div>
                    </div>
                </div>
                <div class="mc-field-group">
                    <div class="row collapse">
                        <div class="small-3 columns"><label for="mce-LNAME">Last Name </label></div>
                        <div class="small-9 columns"><input type="text" value="" name="LNAME" class="" id="mce-LNAME"></div>
                    </div>
                </div>
                <div id="mce-responses" class="clear">
                    <div class="response" id="mce-error-response" style="display:none"></div>
                    <div class="response" id="mce-success-response" style="display:none"></div>
                </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;"><input type="text" name="b_df8bb543c68230d5f7b4dcf78_9a4589f144" tabindex="-1" value=""></div>
                <div class="clear"><input type="submit" class="button" value="Sign up" name="subscribe" id="mc-embedded-subscribe"></div>
            </div>
        </form>
    </div>
</div>

<!-- end newsleter modal -->



<!-- footer.html -->
<footer id="footer">
    <div class="footer-top">
        <a class="logo" href="https://www.scylladb.com"><img src="../_static/img/logo-scylla-horizontal-RGB.svg" alt=""></a>
        <div class="footer-links">
            <a class="link" href="https://docs.scylladb.com">Docs</a>
            <a class="link" href="https://www.scylladb.com/company/contact-us/">Contact Us</a>
            <a class="link" href="https://www.scylladb.com/company/">About Us</a>
            <a class="link button" href="https://github.com/scylladb/scylla/issues/new?title=Issue in page Hinted Handoff Design&&body=I%20would%20like%20to%20report%20an%20issue%20in%20page%20https://scylla.docs.scylladb.com/master/design-notes/hinted_handoff_design%0A%0A%23%23%23%20Problem%0A%0A%23%23%23%20%20Suggest%20a%20fix" target="_blank">
                Report an issue on this page</a>
        </div>
        <div class="footer-actions">
            <a class="link-icon" href="https://github.com/ScyllaDB" target="_blank">
                <span class="icon-github2"></span></a>
            <a class="link-icon" href="https://twitter.com/ScyllaDB" target="_blank">
                <span class="icon-twitter"></span></a>
            <a class="link-icon" href="https://www.linkedin.com/company/scylladb"  target="_blank">
                <span class="icon-linkedin2"></span></a>
            <a class="link-icon" href="https://www.facebook.com/scylladb/" target="_blank">
                <span class="icon-facebook"></span></a>
        </div>
    </div>

    <div class="footer-bottom">
        <div class="footer-info">
            <div class="footer-copyright">
                &#169; 2021, ScyllaDB. All rights reserved.
            </div>
            <div class="footer-last-updated">
                Last updated on 11 May 2021.
            </div>
            <div class="footer-version">
                Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
                &amp; <a href="https://pypi.org/project/sphinx-scylladb-theme">ScyllaDB Theme 0.1.23</a>
            </div>
        </div>
        <div class="footer-links">
        </div>
    </div>
</footer>
<!-- end footer.html -->

<!-- bodyscripts.html -->
<!-- at the end of the BODY --> 
<script src="../_static/js/vendor/jquery.js"></script>
<script src="../_static/js/vendor/jquery.cookie.min.js"></script>
<script src="../_static/expertrec.js"></script>
<script src="../_static/js/foundation/foundation.js"></script>
<script src="../_static/js/foundation/foundation.topbar.js"></script>
<script src="../_static/app.js"></script>
<script>
    $(document).foundation();
</script>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-T8P2JP"
  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

  <!-- end bodyscripts.html -->
</body>
</html>